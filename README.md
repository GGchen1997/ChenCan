# ChenCan
# lab3实验报告
标签（空格分隔）： PB15151793 陈灿

---

本次实验主要完成ucore内核对虚拟内存的管理工作。其总体设计思路还是比较简单，即首先完成初始化虚拟内存管理机制，即需要设置好哪些页需要放在物理内存中，哪些页不需要放在物理内存中，而是可被换出到硬盘上，并涉及完善建立页表映射、页错误异常处理操作等函数实现。然后就执行一组访存测试，看看我们建立的页表项是否能够正确完成虚实地址映射，是否正确描述了虚拟内存页在物理内存中还是在硬盘上，是否能够正确把虚拟内存页在物理内存和硬盘之间进行传递，是否正确实现了页面替换算法等。

##练习0 . 填写已有实验
同样与lab2类似，使用meld的一款文件比对工具，直接比对lab2和lab3两个文件夹，把其中不相同的部分列举出来，然后比对进行修改即可。比对修改之后，大致罗列一下有以下文件需要我们进行修改：

 - default_pmm.c
 - pmm.c
 - trap.c123
 - kdebug.c

主要不同的就是上述4个文件了，我直接在meld里面看见不同的，就复制完成了。
##练习1 .给未被映射的地址映射上物理页

若“合法”虚拟页已经被描述地很完备了,当ucore访问这些“合法”虚拟页时,会由于没有虚实地址映射而产生页访问异常。练习1完成后,do_pgfault函数会申请一个空闲物理页,并建立好虚实映射关系,从而使得这样的“合法”虚拟页有实际的物理页帧对应。

实验要求完成 do_pgfault函数，作用给未被映射的地址映射上物理页。 具体而言，当启动分页机制以后，如果一条指令或数据的虚拟地址所对应的物理页框不在内存中或者访问的类型有错误（比如写一个只读页或用户态程序访问内核态的数据等），就会发生页错误异常。产生页面异常的原因主要有:

 - 目标页面不存在（页表项全为0，即该线性地址与物理地址尚未建立映射或者已经撤销）; 
 - 相应的物理页面不在内存中（页表项非空，但Present标志位=0，比如在swap分区或磁盘文件上）
 - 访问权限不符合（此时页表项P标志=1，比如企图写只读页面）.

当出现上面情况之一,那么就会产生页面异常。

查看实验代码相关注释：
> The contents of the CR2 register. The processor loads the CR2 register with the 32-bit linear address that generated the exception. The do_pgfault fun can use this address to locate the corresponding page directory and page-table entries.

可以知道，CR2是页故障线性地址寄存器,保存最后一次出现页故障的全32位线性地址。CR2用于发生页异常时报告出错信息。当发生页异常时,处理器把引起页异常的线性地址保存在CR2中。操作系统中对应的中断服务例程可以检查CR2的内容,从而查出线性地址空间中
